/*! visualizations - v0.1.3 - 2014-05-04 */angular.module("templates-sleepcycle",["templates/sleepcycle.tpl.html"]),angular.module("templates/sleepcycle.tpl.html",[]).run(["$templateCache",function(a){a.put("templates/sleepcycle.tpl.html",'<svg ng-mousemove="movement($event)" ng-attr-width="{{width}}" ng-attr-height="{{height}}"><defs><lineargradient id="sun-grad" x1="0%" y1="0%" x2="100%" y2="0%"><stop offset="0%" style="stop-color:#FF8034;stop-opacity:1"><stop offset="100%" style="stop-color:#FFC02D;stop-opacity:1"></lineargradient></defs><g><path class="clock" ng-attr-d="{{clockPath}}" ng-attr-transform="translate({{center}}, {{center}})"></path><path class="tick" ng-repeat="tick in ticks" d="M0 0L0 10" ng-attr-transform="translate({{center}}, {{center}}) rotate({{tick.angle}}) translate(0, {{clock.outerRadius -10}})"></path><text class="tick-text" ng-repeat="tick in ticks | clockticks" ng-attr-transform="translate({{center}}, {{center}})\n                       rotate({{tick.angle}})\n                       translate(0, {{clock.outerRadius -15}})" text-anchor="middle">{{tick.text}}</text><path class="outer-shell" ng-attr-d="{{outerArcPath}}" ng-attr-transform="translate({{center}}, {{center}})" ng-mouseover="mouseoverEvent(null)"></path><path ng-attr-d="{{clockHandPath}}" class="clock-hand" ng-attr-transform="translate({{center}}, {{center}}) rotate({{clockHandAngle}})\n    translate(0, {{clock.outerRadius}})"></path><path ng-repeat="event in sleepEvents" ng-attr-transform="translate({{center}}, {{center}})" ng-attr-d="{{event.path}}" ng-class="event.colorClass" class="sleep-event" ng-mouseover="mouseoverEvent(event)"></path><text class="center-text" ng-attr-transform="translate({{center}}, {{center}})" text-anchor="middle">{{eventText}}</text><path ng-attr-d="{{sunPath}}" ng-attr-transform="translate({{center}}, {{center}})" class="sun-border" ng-class="sunClass"></path><text class="center-text" ng-attr-transform="translate({{center}}, {{center + 48}})" text-anchor="middle" ng-style="qualityStyle">{{qualityText}}</text><text class="current-hour-text" text-anchor="middle" ng-attr-transform="translate({{center}}, {{height}})" ng-bind="currentDate"></text></g></svg>')}]);var sleepcycle=angular.module("sleepcycle",["templates-sleepcycle"]);sleepcycle.directive("sleepCycle",function(){function a(a,b){var c="";return c=b?"daytime-":"nighttime-",a=Math.floor(a),c+=a>=6?5-a%6:a}function b(a){var b=0;return b=a>12?360*(a-12)/24:360*(a+12)/24,{angle:b,text:a,textTranslate:a>9?-8:-4}}function c(a){return a*Math.PI/180}function d(a){return 180*a/Math.PI}function e(a){var b=6+12*a/Math.PI;return 0>b?b+24:b}function f(a,d,e){e.sleepData.forEach(function(a){var d={innerRadius:e.outerArc.innerRadius,outerRadius:e.outerArc.outerRadius,startAngle:c(b(a.startTime.getHours()+a.startTime.getMinutes()/60).angle+180),endAngle:c(b(a.endTime.getHours()+a.endTime.getMinutes()/60).angle+180)};d.path=e.arcDefinition(d),d.colorClass=a.colorClass,d.description=a.description,e.sleepEvents.push(d),e.currentDate=e.sleepData[0].startTime.toLocaleDateString(),e.sleepData[0].startTime.getHours()<=12?e.breakpointInDate=!1:(e.breakpointInDate=!0,e.dateBeforeMidnight=e.sleepData[0].startTime,e.dateAfterMidnight=new Date(e.sleepData[0].startTime.getTime()+864e5+1),e.breakpointHour=e.sleepData[0].startTime.getHours())})}return{restrict:"E",templateUrl:"templates/sleepcycle.tpl.html",scope:{width:"@",sleepData:"=",sleepQuality:"@",sunrise:"@",sunset:"@"},link:function(c,g){c.rootElement=g[0],c.width=parseFloat(c.width),c.bottomMargin=20,c.height=c.width+c.bottomMargin,c.clockPath="",c.clock={innerRadius:0,outerRadius:.3*c.width,startAngle:0,endAngle:2*Math.PI},c.center=c.width/2,c.arcDefinition=d3.svg.arc(),c.clockPath=c.arcDefinition(c.clock),c.ticks=_.map(_.range(24),b),c.outerArc={innerRadius:c.clock.outerRadius,outerRadius:.1*c.width+c.clock.outerRadius,startAngle:0,endAngle:2*Math.PI},c.outerArcPath=c.arcDefinition(c.outerArc),c.sleepEvents=[],c.$watchCollection("sleepData",f),c.eventText="Daytime",c.mouseoverEvent=function(a){c.eventText=a?a.description:"Idle"},c.sunPath=c.arcDefinition({innerRadius:c.outerArc.outerRadius,outerRadius:c.outerArc.outerRadius+20,startAngle:0,endAngle:2*Math.PI}),c.clockHandPath="M0,0V"+(c.outerArc.outerRadius-c.outerArc.innerRadius),c.clockHandAngle=0,c.currentDate="",c.movement=function(b){var f=c.rootElement.offsetLeft+c.center,g=c.rootElement.offsetTop+c.center,h=Math.atan2(b.clientY-g,b.clientX-f);c.clockHandAngle=d(h)-90;var i=e(h),j=c.sunset-c.sunrise,k=24-j;if(i>=c.sunrise&&i<=c.sunset){var l=j/12,m=(i-c.sunrise)/l;c.sunClass=a(m,!0)}else{var l=k/12,m=null;m=i-c.sunset>0?(i-c.sunset)/l:(i+24-c.sunset)/l,c.sunClass=a(m,!1)}c.breakpointInDate&&(c.currentDate=i<c.breakpointHour?c.dateAfterMidnight.toLocaleDateString():c.dateBeforeMidnight.toLocaleDateString())},c.$watch("sleepQuality",function(){var a=12,b=18,d=(b-a)*c.sleepQuality/100+a;c.qualityText=c.sleepQuality+"%",c.qualityStyle={"font-size":d+"px"}})}}}),sleepcycle.filter("clockticks",function(){return function(a){return _.filter(a,function(a){return parseInt(a.text)%3==0})}});